<!DOCTYPE html>

<html>
<head>
  <title>Kissmetrics JS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Kissmetrics JS</h1>
<h2>Bootstrap</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Keep track of what environment we&#39;re running in, Node.js or a browser.
If we&#39;re in Node, require the <code>https</code> module for our network requests.</p>
<p>If we&#39;re in a browser we&#39;ll just use the implicit requests generated by
<code>Image</code>&#39;s <code>src</code> property. Kissmetrics responds to API requests with an
<code>image/gif</code> content type, so the browser won&#39;t throw up any warnings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>ENV = <span class="keyword">if</span> <span class="keyword">typeof</span> exports <span class="keyword">isnt</span> <span class="string">'undefined'</span> <span class="keyword">then</span> <span class="string">'node'</span> <span class="keyword">else</span> <span class="string">'browser'</span>

https = require <span class="string">'https'</span> <span class="keyword">if</span> ENV <span class="keyword">is</span> <span class="string">'node'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>HTTP Request</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Generic wrapper for HTTP requests that abstracts the differences between
requests made in Node and in a browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">httpRequest</span></span> = (url) -&gt;
	<span class="keyword">if</span> ENV <span class="keyword">is</span> <span class="string">'node'</span>
		https.get url
	<span class="keyword">else</span>
		(<span class="keyword">new</span> Image()).src = url</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Kissmetrics Client</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Wrapper for interacting with the Kissmetrics API.</p>
<p>Instantiates a new client with your Kissmetrics API key and an identifier
for the person you&#39;re recording data about. A new client must be created
for each person you record data about.</p>
<p><code>key</code> (String): Your API key from Kissmetrics</p>
<p><code>person</code> (String): An identifier for the person you&#39;ll record data about</p>
<pre><code>km = new KissmetricsClient(API_KEY, &#39;evan@example.com&#39;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">KissmetricsClient</span></span>
	constructor: (<span class="property">@key</span>, <span class="property">@person</span>) -&gt;
		<span class="property">@host</span>        = <span class="string">'trk.kissmetrics.com'</span>
		<span class="property">@port</span>        = <span class="number">80</span>
		<span class="property">@query_types</span> =
			record : <span class="string">'e'</span>
			set    : <span class="string">'s'</span>
			alias  : <span class="string">'a'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3>Record</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Record an &quot;event&quot; in Kissmetrics.
<a href="http://support.kissmetrics.com/apis/common-methods#record">http://support.kissmetrics.com/apis/common-methods#record</a></p>
<p><code>action</code> (String): Name of the event you&#39;re recording. This is
  usually something a person did or something that affects them.</p>
<p><code>properties</code> (Object) <em>Optional</em>: Properties to associate with
  the person&#39;s event. Keys will be used as property names and values
  as property values.</p>
<pre><code>km.record(&#39;Signed up&#39;, {page: &#39;home&#39;})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>	record: (action, properties = {}) -&gt;
		properties._n = action
		<span class="property">@_generateQuery</span> <span class="string">'record'</span>, properties</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <h3>Set</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Set a &quot;property&quot; in Kissmetrics.
<a href="http://support.kissmetrics.com/apis/common-methods#set">http://support.kissmetrics.com/apis/common-methods#set</a></p>
<p><code>properties</code> (Object): Properties to associate with
  the person&#39;s event. Keys will be used as property names and values
  as property values.</p>
<p>This behaves exactly like the <code>properties</code> argument in <code>record</code> except
that it is required and that each property has to be sent in its own query.</p>
<pre><code>km.set({location: &#39;San Francisco&#39;, gender: &#39;male&#39;})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>	set: (properties) -&gt;
		<span class="keyword">for</span> name, value <span class="keyword">of</span> properties
			data       = {}
			data[name] = value
			<span class="property">@_generateQuery</span> <span class="string">'set'</span>, data</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h3>Alias</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Alias a person to another &quot;identity&quot; in Kissmetrics.
<a href="http://support.kissmetrics.com/apis/common-methods#alias">http://support.kissmetrics.com/apis/common-methods#alias</a></p>
<p><code>to</code> (String): A new identifier to map to the <code>@person</code> set on
the current instance.</p>
<pre><code>km.alias(&#39;evan+newemail@example.com&#39;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>	alias: (to) -&gt;
		<span class="property">@_generateQuery</span> <span class="string">'alias'</span>, _n: to</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h3>Generate Query</h3>
<h4>(Private)</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Prepare data to be sent to Kissmetrics by turning it into a URL path
and query string. Once the query is formed, call <code>record()</code> to send
it to Kissmetrics.</p>
<ul>
<li><p><code>type</code> (String): Type of data being sent (<code>record</code>, <code>set</code> or <code>alias</code>).</p>
</li>
<li><p><code>data</code> (Object): Specific data being recorded about this person.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_generateQuery: (type, data) -&gt;
		data._k = <span class="property">@key</span>
		data._p = <span class="property">@person</span>

		queryParts = []
		<span class="keyword">for</span> key, val <span class="keyword">of</span> data
			queryParts.push <span class="string">"<span class="subst">#{encodeURIComponent(key)}</span>=<span class="subst">#{encodeURIComponent(val)}</span>"</span>

		queryString = queryParts.join <span class="string">'&amp;'</span>

		<span class="property">@_request</span> <span class="string">"<span class="subst">#{@query_types[type]}</span>?<span class="subst">#{queryString}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <h3>Request</h3>
<h4>(Private)</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Query the Kissmetrics API</p>
<p><code>endpoint</code> (String): URL path (without a leading slash) that will be used
  as a Kissmetrics API endpoint.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	_request: (endpoint) -&gt;
		httpRequest <span class="string">"https://<span class="subst">#{@host}</span>:<span class="subst">#{@port}</span>/<span class="subst">#{endpoint}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3>Exports</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Make <code>KissmetricsClient</code> available either as a Node module or a property
on the current context in the browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> ENV <span class="keyword">is</span> <span class="string">'node'</span>
	exports.KissmetricsClient = KissmetricsClient
<span class="keyword">else</span>
	<span class="property">@KissmetricsClient</span> = KissmetricsClient</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
