<!DOCTYPE html>

<html>
<head>
  <title>Kissmetrics JS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="kissmetrics-anon.html">
                kissmetrics-anon.coffee
              </a>
            
              
              <a class="source" href="kissmetrics-batch.html">
                kissmetrics-batch.coffee
              </a>
            
              
              <a class="source" href="kissmetrics.html">
                kissmetrics.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>Kissmetrics JS</h1>
<h2>Bootstrap</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Keep track of what environment we&#39;re running in, Node.js or a browser.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>NODEJS = <span class="keyword">typeof</span> exports <span class="keyword">isnt</span> <span class="string">'undefined'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>If we&#39;re in Node, require the <code>https</code> module for our network requests.</p>
<p>If we&#39;re in a browser we&#39;ll just use the implicit requests generated by
<code>Image().src</code>. Kissmetrics responds to API requests with an <code>image/gif</code>
content type, so the browser won&#39;t throw up any warnings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>https = require <span class="string">'https'</span> <span class="keyword">if</span> NODEJS <span class="keyword">is</span> <span class="literal">on</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2>Kissmetrics Client</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Wrapper for interacting with the Kissmetrics API.</p>
<p>Instantiates a new client with your Kissmetrics API key and an identifier
for the person you&#39;re recording data about. A new client must be created
for each person you record data about.</p>
<p>All data methods (<code>record</code>, <code>set</code>, <code>alias</code>) are chainable.</p>
<pre><code>km = new KissmetricsClient(API_KEY, user);
km.record(&#39;Changed username&#39;)
  .alias(user.newname)
  .set({mood: &#39;indecisive&#39;});</code></pre>
<h5>Arguments</h5>
<p><code>apiKey</code> (String): Your API key from Kissmetrics</p>
<p><code>person</code> (String): An identifier for the person you&#39;ll record data about</p>
<p><code>options</code> <em>Optional</em> (Object):
  <em> <code>queue</code>: Indicates you want to batch queries. Must be an object with
    an <code>add()</code> method. All queries recorded on instances that defined this
    option will be added to the queue and </em>not<em> sent immediately. This
    option is </em>only* supported on the server. Currently the <code>apiKey</code>
    argument is ignored when requests are batched because an API key is
    specified in the batch request headers.</p>
<pre><code>km = new KissmetricsClient(API_KEY, &#39;evan@example.com&#39;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="class"><span class="keyword">class</span> <span class="title">KissmetricsClient</span></span>
  <span class="property">@HOST</span>: <span class="string">'trk.kissmetrics.com'</span>
  <span class="property">@QUERY_TYPES</span>:
    record : <span class="string">'e'</span>
    set    : <span class="string">'s'</span>
    alias  : <span class="string">'a'</span>

  constructor: (<span class="property">@apiKey</span>, <span class="property">@person</span>, options = {}) -&gt;
    <span class="property">@queries</span> = []

    <span class="keyword">if</span> NODEJS <span class="keyword">is</span> <span class="literal">on</span> <span class="keyword">and</span> options.queue
      BatchClient = require <span class="string">'./kissmetrics-batch'</span>
      <span class="property">@batchClient</span> = <span class="keyword">new</span> BatchClient options.queue</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h3>Record</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Record an &quot;event&quot; in Kissmetrics.</p>
<p><a href="http://support.kissmetrics.com/apis/common-methods#record">http://support.kissmetrics.com/apis/common-methods#record</a></p>
<h5>Arguments</h5>
<p><code>action</code> (String): Name of the event you&#39;re recording. This is
  usually something a person did or something that affects them.</p>
<p><code>properties</code> <em>Optional</em> (Object): Properties to associate with
  the person&#39;s event. Keys will be used as property names and values
  as property values.</p>
<pre><code>km.record(&#39;Signed up&#39;, {page: &#39;home&#39;})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  record: (action, properties = {}) -&gt;
    properties._n = action
    <span class="property">@_generateQuery</span> <span class="string">'record'</span>, properties</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3>Set</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set a &quot;property&quot; in Kissmetrics.</p>
<p><a href="http://support.kissmetrics.com/apis/common-methods#set">http://support.kissmetrics.com/apis/common-methods#set</a></p>
<h5>Arguments</h5>
<p><code>properties</code> (Object): Properties to associate with the person. Keys
  will be used as property names and values as property values.</p>
<p>This behaves exactly like the <code>properties</code> argument in <code>record</code>, except
it includes an additional safety check to make sure you don&#39;t use the
reserved <code>_n</code> property name.</p>
<pre><code>km.set({location: &#39;San Francisco&#39;, gender: &#39;male&#39;})</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  set: (properties) -&gt;
    <span class="keyword">delete</span> properties._n
    <span class="property">@_generateQuery</span> <span class="string">'set'</span>, properties</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <h3>Alias</h3>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Alias a person to another &quot;identity&quot; in Kissmetrics. Updates the current
instance&#39;s <code>person</code> attribute to the new identity.</p>
<p><a href="http://support.kissmetrics.com/apis/common-methods#alias">http://support.kissmetrics.com/apis/common-methods#alias</a></p>
<h5>Arguments</h5>
<p><code>to</code> (String): A new identifier to map to the <code>@person</code> set on
the current instance.</p>
<pre><code>km.alias(&#39;evan+newemail@example.com&#39;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>  alias: (to) -&gt;
    _<span class="keyword">return</span> = <span class="property">@_generateQuery</span> <span class="string">'alias'</span>, _n: to
    <span class="property">@person</span> = to
    <span class="keyword">return</span> _<span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <h3>HTTPS Request</h3>
<h4>(Private)</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Generic wrapper for HTTPS requests that abstracts the differences between
requests made in Node and in a browser.</p>
<h5>Arguments</h5>
<ul>
<li><code>args</code> (Object): Key value pairs of URL pieces; only <code>host</code> and
<code>path</code> are used, and <code>host</code> is required.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _httpsRequest: (args) -&gt;
    url = <span class="string">"https://<span class="subst">#{args.host}</span>/<span class="subst">#{args.path || ''}</span>"</span>

    <span class="keyword">if</span> NODEJS <span class="keyword">is</span> <span class="literal">on</span> <span class="keyword">then</span> https.get url <span class="keyword">else</span> (<span class="keyword">new</span> Image()).src = url</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <h3>Validate Data</h3>
<h4>(Private)</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Ensures that reserved keys that are used (<code>_k</code> for API key and <code>_p</code>
for person) are present and set correctly, regardless of whether they
were in the original data.</p>
<p><a href="http://support.kissmetrics.com/apis/specifications.html">http://support.kissmetrics.com/apis/specifications.html</a></p>
<h5>Arguments</h5>
<ul>
<li><code>data</code> (Object): Specific data being recorded about this person.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _validateData: (data) -&gt;
    <span class="keyword">if</span> <span class="property">@apiKey</span> <span class="keyword">then</span> data._k = <span class="property">@apiKey</span> <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'API key required'</span>
    <span class="keyword">if</span> <span class="property">@person</span> <span class="keyword">then</span> data._p = <span class="property">@person</span> <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'Person required'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <h3>Generate Query</h3>
<h4>(Private)</h4>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Prepare data to be sent to Kissmetrics. For immediate queries, we convert
to a URL path and query string, then make the HTTP request. For batch
queries, we add a timestamp and append the query object to the queue.</p>
<h5>Arguments</h5>
<ul>
<li><p><code>type</code> (String): Type of data being sent (<code>record</code>, <code>set</code> or <code>alias</code>).</p>
</li>
<li><p><code>data</code> (Object): Specific data being recorded about this person.</p>
</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  _generateQuery: (type, data) -&gt;
    <span class="property">@_validateData</span> data

    <span class="keyword">if</span> <span class="property">@batchClient</span>
      timestamp      = Math.round((<span class="keyword">new</span> Date).getTime() / <span class="number">1000</span>)
      batchData      = data
      batchData.type = type

      <span class="property">@batchClient</span>.add timestamp, batchData

    <span class="keyword">else</span>
      queryParts = <span class="keyword">for</span> key, val <span class="keyword">of</span> data
        [key, val] = (encodeURIComponent param <span class="keyword">for</span> param <span class="keyword">in</span> [key, val])
        <span class="string">"<span class="subst">#{key}</span>=<span class="subst">#{val}</span>"</span>

      queryString = queryParts.join <span class="string">'&amp;'</span>
      queryType   = KissmetricsClient.QUERY_TYPES[type]

      <span class="property">@queries</span>.push <span class="property">@_httpsRequest</span>
        host: KissmetricsClient.HOST
        path: <span class="string">"<span class="subst">#{queryType}</span>?<span class="subst">#{queryString}</span>"</span>

    <span class="keyword">return</span> @</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h2>Exports</h2>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Make <code>KissmetricsClient</code> available either as a Node module or a property
on the current context in the browser.</p>
<pre><code>// Node.js
KM = require(&#39;kissmetrics&#39;)
kmClient = new KM(&#39;apiKey&#39;, &#39;evan&#39;)</code></pre>
<pre><code>// Browser
kmClient = new window.KissmetricsClient(&#39;apiKey&#39;, &#39;evan&#39;)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> NODEJS <span class="keyword">is</span> <span class="literal">on</span>
  module.exports = KissmetricsClient
<span class="keyword">else</span>
  <span class="property">@KissmetricsClient</span> = KissmetricsClient</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
